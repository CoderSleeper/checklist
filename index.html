<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Planner Đổi Xu → Điểm — v7.3d Rocket Finale • Ultra (Complete Banner • Regex Fixed)</title>
  <style>
    :root{
      --bg:#0a0014; --bg2:#120021;
      --neon1:#ff00e5; --neon2:#00eaff; --neon3:#9dff00;
      --text:#e8e9ff; --muted:#b7b8d6;
      --panel:rgba(255,255,255,.06); --panel2:rgba(255,255,255,.09);
      --shadow:0 18px 48px rgba(0,0,0,.5); --radius:18px;
      --grad: linear-gradient(135deg, rgba(255,0,229,.9), rgba(0,234,255,.9) 55%, rgba(157,255,0,.9));
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
      color:var(--text);
      background:
        radial-gradient(900px 600px at 10% -10%, #2a0055 0%, transparent 70%),
        radial-gradient(1000px 700px at 120% 10%, #00384f 0%, transparent 65%),
        linear-gradient(180deg, var(--bg), var(--bg2));
      overflow-x:hidden;
    }
    body::after{content:''; position:fixed; inset:0; pointer-events:none;
      background:repeating-linear-gradient(180deg, rgba(255,255,255,.03) 0 2px, transparent 2px 4px);
      mix-blend-mode:soft-light; opacity:.35; z-index:0}
    #bg{position:fixed; inset:0; z-index:-3; pointer-events:none}
    #fx{position:fixed; inset:0; z-index:9997; pointer-events:none}
    header{position:relative; z-index:10; padding:22px 18px 6px; display:flex; align-items:center; justify-content:space-between}
    h1{margin:0; font-size:clamp(22px,3.2vw,38px)}
    .brand{background:var(--grad); -webkit-background-clip:text; background-clip:text; color:transparent; text-shadow:0 0 16px rgba(255,0,229,.35)}
    .actions{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
    .btn{border:none; outline:none; cursor:pointer; user-select:none; padding:10px 14px; border-radius:12px; font-weight:800;
      background:var(--grad); color:#0b0013; box-shadow:0 0 24px rgba(255,0,229,.35), inset 0 0 0 1px rgba(255,255,255,.25);
      transition:transform .12s ease, filter .12s ease}
    .btn:active{transform:translateY(1px) scale(.99)}
    .ghost{background:var(--panel); color:var(--text); border:1px solid #ffffff2a; box-shadow:0 0 16px rgba(0,234,255,.15)}
    .sub{color:var(--muted); margin:6px 18px 18px}
    .hero{position:relative; padding:18px; border-radius:24px; overflow:hidden; box-shadow:var(--shadow);
      background:linear-gradient(135deg, rgba(255,0,229,.18), rgba(0,234,255,.18) 60%, rgba(157,255,0,.18));
      margin:0 18px 12px; border:1px solid #ffffff1f}
    .hero .title{display:flex; align-items:center; justify-content:space-between; margin-bottom:12px}
    .hero .grid{gap:14px}
    .hero label{color:#eaffff; font-weight:800; text-shadow:0 0 8px rgba(0,234,255,.25)}
    .hero input{background:rgba(13,8,29,.7); color:#e6e7ff; border:1px solid #6a3a97; border-radius:14px; box-shadow:inset 0 0 0 1px #ffffff1a;
      padding:14px 16px; font-size:17px; transition:transform .12s ease, box-shadow .2s ease}
    .hero input:focus{transform:translateY(-1px); box-shadow:0 0 0 4px rgba(0,234,255,.22), inset 0 0 0 1px #ffffff22}
    .wrap{padding:12px 18px 26px;display:grid;grid-template-columns:1.15fr .85fr;gap:18px}
    @media (max-width:960px){.wrap{grid-template-columns:1fr}}
    .card{background:var(--panel); border:1px solid #ffffff1c; border-radius:var(--radius); box-shadow:var(--shadow); padding:16px}
    label{display:block;font-weight:750;margin:12px 0 6px}
    input[type="text"]{width:100%;padding:12px 14px;border:1px solid #ffffff2a;background:rgba(8,5,20,.65);color:var(--text);
      border-radius:12px;font-size:16px;outline:none;transition:.18s ease; box-shadow: inset 0 -1px 0 rgba(255,255,255,.12)}
    input:focus{box-shadow:0 0 0 4px rgba(255,0,229,.25), inset 0 -1px 0 rgba(255,255,255,.12)}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .muted{font-size:12px;color:var(--muted)}
    .result h3{margin:8px 0 12px}
    .stat{display:flex; align-items:center; justify-content:space-between;
      background:linear-gradient(180deg, var(--panel2), rgba(255,255,255,.04));
      border:1px dashed #ffffff33; border-radius:14px; padding:12px 14px; margin-bottom:10px}
    .stat.hl{background:linear-gradient(135deg, rgba(255,0,229,.14), rgba(0,234,255,.14)); border:1px solid #9b5cf6; box-shadow:0 0 28px rgba(255,0,229,.15)}
    .kpis{display:grid; grid-template-columns:auto 1fr; gap:12px; align-items:center}
    .ring{display:flex; flex-direction:column; align-items:center; gap:10px; min-width:120px}
    .ringWrap{position:relative; width:120px; height:120px; filter: drop-shadow(0 0 10px rgba(255,0,229,.3))}
    .ringWrap svg{transform:rotate(-90deg)}
    .ringWrap .pct{position:absolute; inset:0; display:flex; align-items:center; justify-content:center; font-weight:900; font-size:20px}
    .seg{display:inline-flex; background:#ffffff14; border:1px solid #ffffff33; border-radius:999px; overflow:hidden; box-shadow:0 0 22px rgba(0,234,255,.15); margin-top:8px}
    .seg button{background:transparent; color:var(--text); padding:6px 12px; border:none; cursor:pointer; font-size:20px; line-height:1}
    .seg button.active{background:var(--grad); color:#120021}
    .bar{height:8px; border-radius:999px; background:#2e1e45; overflow:hidden; box-shadow:inset 0 0 8px #000}
    .bar > span{display:block; height:100%; width:0%; background:var(--grad); transition:width .4s cubic-bezier(.4,0,.2,1)}
    .toast{position:fixed; left:50%; transform:translateX(-50%); bottom:20px;
      background:#0d0b18cc; color:#fff; padding:10px 14px; border-radius:12px; opacity:0; pointer-events:none;
      transition:opacity .25s ease, transform .25s ease; backdrop-filter: blur(6px); z-index:99999}
    .toast.show{opacity:1; transform:translateX(-50%) translateY(-4px)}
    .checkCard{margin: 0 18px 28px}
    .cl{list-style:none; padding:0; margin:8px 0 0; display:grid; gap:10px}
    .cl li{display:flex; align-items:center; gap:12px; padding:12px; border-radius:14px; border:1px solid #ffffff24;
      background:linear-gradient(180deg, var(--panel2), rgba(255,255,255,.04));}
    .tick{width:28px; height:28px; border-radius:50%; border:2px solid #ffffff55; display:grid; place-items:center; color:#fff}
    .achieved{border-color:#ff00e5aa; box-shadow:0 0 22px rgba(255,0,229,.25)}
    .achieved .tick{background:var(--grad); border-color:transparent}
    .achieved b{background:var(--grad); -webkit-background-clip:text; background-clip:text; color:transparent}
    .ctl{display:flex; gap:10px; justify-content:flex-end; margin-top:10px}

    .complete{
      --glow1: .35;
      --glow2: .22;
      position:fixed; z-index:99998; left:50%; top:42%;
      transform:translate(-50%,-50%); pointer-events:none;
      font-weight:1000; text-transform:uppercase; letter-spacing:.14em;
      font-size:clamp(32px,10vw,120px);
      background:linear-gradient(135deg,#ffd07a,#fff3d1 45%,#ffb35c);
      -webkit-background-clip:text; background-clip:text; color:transparent;
      text-shadow: 0 0 18px rgba(255,200,40,var(--glow1)), 0 0 36px rgba(255,140,0,var(--glow2));
      opacity:0; filter:drop-shadow(0 0 8px rgba(255,200,40,.2));
      transition:opacity .4s ease, transform .6s ease;
    }
    .complete.show{ opacity:1; transform:translate(-50%,-50%) scale(1.02); }
  </style>
</head>
<body>
  <canvas id="bg"></canvas>
  <canvas id="fx"></canvas>
  <div id="complete" class="complete" aria-hidden="true">COMPLETE</div>

  <header>
    <h1><span class="brand">Planner đổi Xu → Điểm</span> <span style="opacity:.85">• Rocket Finale v7.3d</span></h1>
    <div class="actions">
      <button class="btn ghost" id="resetBtn">Reset dữ liệu</button>
      <button class="btn ghost" id="hapticBtn">Rung: Bật</button>
      <button class="btn" id="copyBtn">Copy kế hoạch</button>
    </div>
  </header>
  <div class="sub">Finale 100%: 5 tên lửa (3 giữa + 2 hai bên) + trail glow + screen flash + <b>shockwave mờ</b> + <b>heat‑distortion</b> + <b>mưa sao băng</b>.</div>

  <section class="hero">
    <div class="title">
      <h2>Thông số mục tiêu</h2>
      <div class="muted">Nhập mốc & số ngày</div>
    </div>
    <div class="grid">
      <div>
        <label for="target">Tổng điểm full (mốc nhận thưởng)</label>
        <input id="target" type="text" inputmode="numeric" placeholder="VD: 26510" value="26510">
      </div>
      <div>
        <label for="days">Số ngày còn lại</label>
        <input id="days" type="text" inputmode="numeric" placeholder="VD: 13" value="13">
      </div>
    </div>
  </section>

  <section class="wrap">
    <div class="card">
      <div class="grid">
        <div>
          <label for="havePoint">Điểm hiện có</label>
          <input id="havePoint" type="text" inputmode="numeric" placeholder="VD: 2950" value="2950">
        </div>
        <div>
          <label for="haveXu">Xu hiện có</label>
          <input id="haveXu" type="text" inputmode="numeric" placeholder="VD: 855" value="855">
        </div>
      </div>
      <div class="grid">
        <div>
          <label for="ppx">Điểm nhận được mỗi lượt đổi</label>
          <input id="ppx" type="text" inputmode="numeric" placeholder="VD: 20" value="20">
        </div>
        <div>
          <label for="xpx">Xu tiêu hao mỗi lượt đổi</label>
          <input id="xpx" type="text" inputmode="numeric" placeholder="VD: 100" value="100">
        </div>
      </div>
      <div class="muted">Gõ số bình thường; hệ thống tự hiểu dấu phẩy/chấm.</div>
    </div>

    <div class="card result">
      <h3>Kết quả</h3>
      <div class="kpis">
        <div class="ring">
          <div class="ringWrap">
            <svg width="120" height="120" viewBox="0 0 120 120">
              <defs>
                <linearGradient id="galaxyGrad" x1="0" y1="0" x2="1" y2="1">
                  <stop offset="0%"  stop-color="#ff00e5"/>
                  <stop offset="45%" stop-color="#00eaff"/>
                  <stop offset="100%" stop-color="#9dff00"/>
                </linearGradient>
              </defs>
              <circle cx="60" cy="60" r="50" stroke="#2b1b40" stroke-width="12" fill="none"/>
              <circle id="ring" cx="60" cy="60" r="50" stroke="url(#galaxyGrad)" stroke-linecap="round" stroke-width="12" fill="none" stroke-dasharray="314" stroke-dashoffset="314"/>
            </svg>
            <div class="pct" id="pct">0%</div>
          </div>
          <div class="seg" id="seg" role="tablist" aria-label="Chế độ vòng tiến độ">
            <button id="modeNow" class="active" data-mode="now" title="Hiện tại" aria-label="Hiện tại">🥵</button>
            <button id="modeMax" data-mode="max" title="Sau khi đổi hết xu" aria-label="Sau khi đổi hết xu">🤩</button>
          </div>
        </div>
        <div>
          <div class="stat hl"><span>Điểm còn thiếu</span><b id="needPoint">0</b></div>
          <div class="stat"><span>Số lượt cần đổi</span><b id="needTurn">0</b></div>
          <div class="stat"><span>Xu cần để đủ mốc</span><b id="needXu">0</b></div>
          <div class="stat hl"><span>Xu còn thiếu (trừ xu đang có)</span><b id="lackXu">0</b></div>
        </div>
      </div>

      <div class="stat"><span>Với xu hiện có (đổi tối đa)</span><b id="canNow">0 điểm</b></div>
      <div class="stat"><span>Kế hoạch dàn đều / ngày</span><b id="perDay">0 xu • 0 lượt • 0 điểm</b></div>
      <div class="bar" title="Tiến độ đạt mốc"><span id="bar" style="width:0%"></span></div>
      <div class="toolbar" style="margin-top:12px; display:flex; gap:10px; flex-wrap:wrap">
        <button class="btn ghost" id="confettiBtn">🎊 Bắn thử pháo</button>
        <button class="btn ghost" id="finaleBtn">🚀 Replay Finale 100%</button>
      </div>
    </div>
  </section>

  <section class="card checkCard">
    <h3>Checklist mốc (dựa theo: <span id="modeNote">🥵 Hiện tại</span>)</h3>
    <ul class="cl">
      <li id="ms25"><div class="tick">✓</div><div class="li-txt"><b>25%</b> • <span class="li-sub" id="ts25">Chưa đạt</span></div></li>
      <li id="ms50"><div class="tick">✓</div><div class="li-txt"><b>50%</b> • <span class="li-sub" id="ts50">Chưa đạt</span></div></li>
      <li id="ms75"><div class="tick">✓</div><div class="li-txt"><b>75%</b> • <span class="li-sub" id="ts75">Chưa đạt</span></div></li>
      <li id="ms100"><div class="tick">✓</div><div class="li-txt"><b>100%</b> • <span class="li-sub" id="ts100">Chưa đạt</span></div></li>
    </ul>
    <div class="ctl">
      <button class="btn ghost" id="resetMs">Reset checklist</button>
    </div>
  </section>

  <div class="toast" id="toast" role="status" aria-live="polite">Đã copy kế hoạch.</div>

  <script>
  // ===== Helpers & State =====
  const $ = (id) => document.getElementById(id);
  const STORAGE_KEY = 'shooting_star_planner_v7_3d_ultra_complete_regexfix';
  const prefersReduced = window.matchMedia('(prefers-reduced-motion: reduce)').matches;
  const num = (v) => { 
    if(typeof v !== 'string') v = String(v ?? ''); 
    v = v.replace(/[^\d,.\-]/g,'').replace(/,/g,''); 
    const sign = v.trim().startsWith('-') ? -1 : 1; 
    v = v.replace(/-/g,''); 
    const out = parseFloat(v); 
    return isNaN(out) ? 0 : out * sign; 
  };
  const fmtInt = (x) => new Intl.NumberFormat('vi-VN').format(Math.max(0, Math.floor(x)));
  const nowStamp = () => new Date().toLocaleString('vi-VN');
  const toast = (t="Đã copy") => { const el = $('toast'); el.textContent = t; el.classList.add('show'); setTimeout(()=>el.classList.remove('show'), 1600); };

  let ringMode='now';
  let milestones = { "25": null, "50": null, "75": null, "100": null };
  let settings = { haptics: true };
  let finalePlayed = false;
  window.forceFX = false;

  function getState(){ return {
    ringMode, milestones, settings,
    target: $('target').value, days: $('days').value, havePoint: $('havePoint').value,
    haveXu: $('haveXu').value, ppx: $('ppx').value, xpx: $('xpx').value
  };}
  function setState(s){ if(!s) return;
    ['target','days','havePoint','haveXu','ppx','xpx'].forEach(k=> { if(s[k] != null && $(k)) $(k).value = s[k]; });
    if(s.ringMode) ringMode = s.ringMode;
    if(s.milestones) milestones = s.milestones;
    if(s.settings) settings = Object.assign(settings, s.settings);
    setModeButtons(); renderMilestonesMeta();
  }
  function saveNow(){ try{ localStorage.setItem(STORAGE_KEY, JSON.stringify(getState())); }catch(e){} }
  function loadSaved(){ try{ const raw = localStorage.getItem(STORAGE_KEY); if(raw) setState(JSON.parse(raw)); }catch(e){} }

  function vibrate(pattern){ if(settings.haptics && 'vibrate' in navigator) { try{ navigator.vibrate(pattern); }catch(e){} } }
  function updateHapticBtn(){ $('hapticBtn').textContent = 'Rung: ' + (settings.haptics ? 'Bật' : 'Tắt'); }
  document.addEventListener('click', (e)=>{
    if(e.target && e.target.id === 'hapticBtn'){
      settings.haptics=!settings.haptics; updateHapticBtn(); saveNow(); if(settings.haptics) vibrate([12,30,12]);
    }
  });

  function setModeButtons(){
    $('modeNow').classList.toggle('active', ringMode==='now');
    $('modeMax').classList.toggle('active', ringMode==='max');
    $('modeNote').textContent = ringMode==='now' ? '🥵 Hiện tại' : '🤩 Sau khi đổi hết xu';
  }
  function renderMilestonesMeta(){
    ['25','50','75','100'].forEach(k => {
      const tsEl = $('ts'+k);
      if(!tsEl) return;
      tsEl.textContent = milestones[k] ? ('Đạt lúc ' + milestones[k]) : 'Chưa đạt';
      $('ms'+k).classList.toggle('achieved', !!milestones[k]);
    });
  }

  // ===== Background stars =====
  const bg = $('bg'); const bgctx = bg.getContext('2d'); let BW=0,BH=0,stars=[]; let starAnimOn = true;
  let starFade = 1.0, starFadeTarget = 1.0; let starFadeEase = 0.04;
  let afterglow = 0.0;
  function resizeBg(){ BW=bg.width=window.innerWidth; BH=bg.height=window.innerHeight; }
  resizeBg(); window.addEventListener('resize', resizeBg);
  function initStars(){ stars = Array.from({length: 170}, () => ({ x: Math.random()*BW, y: Math.random()*BH, r: Math.random()*1.5+0.3, s: Math.random()*0.6+0.2, c: Math.random()<.5?'#fff':(Math.random()<.5?'#ff00e5':'#00eaff') })); }
  function drawBg(){ if(!starAnimOn){ if(afterglow>0){ const g=bgctx.createRadialGradient(BW/2,BH*0.18, 10, BW/2,BH*0.18, Math.max(BW,BH)*0.9);
      g.addColorStop(0, `rgba(255,240,200,${afterglow*0.18})`);
      g.addColorStop(1, 'rgba(255,240,200,0)');
      bgctx.fillStyle=g; bgctx.fillRect(0,0,BW,BH);
      afterglow = Math.max(0, afterglow - 0.004); }
    requestAnimationFrame(drawBg); return; }
    bgctx.clearRect(0,0,BW,BH);
    starFade += (starFadeTarget - starFade)*starFadeEase;
    for(const st of stars){ bgctx.globalAlpha = (.35 + Math.random()*.55) * starFade; bgctx.fillStyle = st.c; bgctx.beginPath(); bgctx.arc(st.x,st.y,st.r,0,Math.PI*2); bgctx.fill();
      st.x += st.s*0.2; st.y -= st.s*0.05; if(st.x>BW+10) st.x=-10; if(st.y<-10) st.y=BH+10; }
    if(afterglow>0){ const g=bgctx.createRadialGradient(BW/2,BH*0.18, 10, BW/2,BH*0.18, Math.max(BW,BH)*0.9);
      g.addColorStop(0, `rgba(255,240,200,${afterglow*0.18})`);
      g.addColorStop(1, 'rgba(255,240,200,0)');
      bgctx.fillStyle=g; bgctx.fillRect(0,0,BW,BH);
      afterglow = Math.max(0, afterglow - 0.004); }
    requestAnimationFrame(drawBg);
  }
  initStars(); drawBg(); document.addEventListener('visibilitychange', ()=>{ starAnimOn = !document.hidden; });

  // ===== FX Engine =====
  const fx = $('fx'); const fxctx = fx.getContext('2d'); let FW=0,FH=0;
  function resizeFx(){ FW=fx.width=window.innerWidth; FH=fx.height=window.innerHeight; }
  resizeFx(); window.addEventListener('resize', resizeFx);

  let confetti = [], rockets = [], shockwaves = [], distort = [], meteors = [];

  let lastT = performance.now();
  let avgFT = 16.7;
  const perfEase = 0.1;
  function perfLevel(){
    const t = Math.max(0, Math.min(1, (50 - avgFT) / (50 - 16)));
    return 0.2 + t*0.8;
  }
  function noise1D(t){
    return Math.sin(t*1.7)*0.62 + Math.sin(t*3.1+1.234)*0.28 + Math.sin(t*5.3+2.345)*0.10;
  }

  const METEOR_COLORS = [
    'rgba(255,200,40,0.95)',
    'rgba(255,140,0,0.95)',
    'rgba(255,255,220,0.95)'
  ];

  let fxAnimId = null, flashAlpha = 0;

  function animateFX(){
    const nowT = performance.now();
    const dt = nowT - lastT; lastT = nowT;
    avgFT = avgFT*(1-perfEase) + dt*perfEase;
    const pL = perfLevel();
    fxctx.clearRect(0,0,FW,FH);

    for(let i=rockets.length-1;i>=0;i--){
      const r = rockets[i];
      if(!prefersReduced){
        const TRAIL_P = Math.max(1, Math.round(5 * pL)); for(let k=0;k<TRAIL_P;k++){
          const hue = Math.random()<0.5? 305 : 185;
          confetti.push({ x:r.x+(Math.random()-0.5)*6, y:r.y+r.size/2+Math.random()*2, vx:(Math.random()-.5)*0.5, vy:1.4+Math.random()*1.6,
            ax:0, ay:0.02, rot:0, vr:0, size:2+Math.random()*3, shape:'circle', col:`hsl(${hue},92%,60%)`, life:0, maxLife:70+Math.random()*50 });
        }
      }
      { const t = nowT*0.001 + r.life*0.015; r.vx += noise1D(t)*0.06; }
      r.vy += r.ay; r.x += r.vx; r.y += r.vy; r.life++;
      r.trail.unshift({x:r.x, y:r.y}); const TRAIL_MAX = Math.round(28 * (0.7 + 0.3*pL)); if(r.trail.length>TRAIL_MAX) r.trail.pop();
      drawTrail(r); drawRocket(r);
      if(r.y < r.targetY || r.life > r.maxLife){
        if(!r.exploded){
          const bx = r.x, by = r.y-12;
          neonBurst(bx, by, r.super? 240 : 160);
          addShockwave(bx, by, r.super? 2 : 1);
          addDistortion(bx, by);
          r.exploded = true;
        }
        rockets.splice(i,1);
      }
    }

    for(let i=confetti.length-1;i>=0;i--){
      const p=confetti[i]; p.vx+=p.ax; p.vy+=p.ay; p.x+=p.vx; p.y+=p.vy; p.rot+=p.vr; p.life++; drawParticle(p);
      if(p.y>FH+60||p.x<-60||p.x>FW+60||p.life>p.maxLife) confetti.splice(i,1);
    }

    for(let i=shockwaves.length-1;i>=0;i--){
      const s=shockwaves[i]; s.r+=s.vr; s.alpha*=s.fade; s.w*=s.fadeW;
      fxctx.save(); fxctx.globalCompositeOperation='screen';
      fxctx.beginPath(); fxctx.arc(s.x,s.y,s.r,0,Math.PI*2);
      fxctx.strokeStyle=`rgba(${s.c[0]},${s.c[1]},${s.c[2]},${s.alpha})`; fxctx.lineWidth=s.w; fxctx.stroke(); fxctx.restore();
      if(s.alpha<0.02||s.r>Math.max(FW,FH)) shockwaves.splice(i,1);
    }

    for(let i=distort.length-1;i>=0;i--){
      const d=distort[i]; d.life++;
      const t=d.life/d.maxLife; const r=d.r + (d.maxR-d.r)*t;
      const wob = 1 + Math.sin(t*10)*0.06; const rot = Math.sin(t*12)*0.2;
      const alpha=(1-t)*0.35; const inner = Math.max(0,r-12), outer=r+22;
      fxctx.save(); fxctx.translate(d.x,d.y); fxctx.rotate(rot); fxctx.scale(wob,wob);
      const g=fxctx.createRadialGradient(0,0,inner, 0,0,outer);
      g.addColorStop(0,'rgba(255,255,255,0)');
      g.addColorStop(0.55,`rgba(255,255,255,${alpha*0.65})`);
      g.addColorStop(0.9,'rgba(255,255,255,0)');
      fxctx.globalCompositeOperation='overlay';
      fxctx.fillStyle=g; fxctx.beginPath(); fxctx.arc(0,0,outer,0,Math.PI*2); fxctx.fill(); fxctx.restore();
      if(t>=1) distort.splice(i,1);
    }

    for(let i=meteors.length-1;i>=0;i--){
      const m=meteors[i];
      { const t = nowT*0.001 + m.life*0.02; m.ax += noise1D(t)*0.002; }
      m.vx+=m.ax; m.vy+=m.ay; m.x+=m.vx; m.y+=m.vy; m.life++;

      fxctx.save();
      fxctx.globalAlpha = Math.max(0, 1 - m.life/(m.maxLife||220));
      fxctx.shadowColor = m.col;
      fxctx.shadowBlur = 4 + 6*pL;
      fxctx.strokeStyle = m.col;
      fxctx.lineWidth = 1 + 1.2*pL;
      fxctx.beginPath();
      fxctx.moveTo(m.x, m.y);
      fxctx.lineTo(m.x - m.vx*6, m.y - m.vy*6);
      fxctx.stroke();

      fxctx.fillStyle = m.col;
      fxctx.beginPath();
      fxctx.arc(m.x, m.y, 2.2, 0, Math.PI*2);
      fxctx.fill();
      fxctx.restore();

      if(m.y>FH+40 || m.x<-40 || m.life>(m.maxLife||220)) meteors.splice(i,1);
    }

    if(flashAlpha>0){ fxctx.fillStyle=`rgba(255,255,255,${flashAlpha})`; fxctx.fillRect(0,0,FW,FH); flashAlpha-= (0.03 + 0.04*(1-pL)); }

    if(confetti.length>0||rockets.length>0||shockwaves.length>0||distort.length>0||meteors.length>0||flashAlpha>0){
      fxAnimId=requestAnimationFrame(animateFX);
    }else{
      cancelAnimationFrame(fxAnimId); fxAnimId=null; fxctx.clearRect(0,0,FW,FH);
    }
  }

  function addShockwave(x,y,rings=1){
    const cols=[[255,255,255],[0,234,255],[255,0,229]];
    for(let i=0;i<rings;i++){
      shockwaves.push({x,y, r:30+i*10, vr:8+i*1.5, alpha:0.45, fade:0.92, w:8 - i*1.5, fadeW:0.97, c:cols[i%cols.length]});
    }
    if(!fxAnimId) animateFX();
  }
  function addDistortion(x,y){
    if(prefersReduced) return;
    distort.push({x,y, r:40, maxR:320, life:0, maxLife:36});
    if(!fxAnimId) animateFX();
  }

  function spawnMeteorRain(duration=1200, density=25, onPulse){
    const start = performance.now();
    const tick = 28;
    const timer = setInterval(()=>{
      const now = performance.now();
      if(now - start > duration){ clearInterval(timer); return; }
      let densEff = density;
      try{ if(typeof perfLevel==='function') densEff = Math.max(3, Math.round(density * (0.45 + 0.55*perfLevel()))); }catch(e){}
      for(let i=0;i<Math.max(1, Math.round(densEff*0.2)); i++){
        const side = Math.random()<0.5? -1 : 1;
        const x0 = (side<0)? -40 : (window.innerWidth+40);
        const y0 = -40 - Math.random()*80;
        const vx = (side<0? 1 : -1) * (2.2 + Math.random()*1.6);
        const vy = 5.2 + Math.random()*2.4;
        const col = Math.random()<0.5? '#ffd07a' : (Math.random()<0.5? '#fff3d1' : '#ffb35c');
        meteors.push({ x:x0, y:y0, vx, vy, ax:0, ay:0.02, life:0, col, maxLife:220 });
      }
      if(typeof onPulse === 'function') onPulse();
      if(!fxAnimId) animateFX();
    }, tick);
  }

  function drawTrail(r){
    if(r.trail.length<2) return;
    for(let i=0;i<r.trail.length-1;i++){
      const p1=r.trail[i], p2=r.trail[i+1];
      const t=1 - i/r.trail.length; const lw=8*t; const a=0.5*t;
      const grad=fxctx.createLinearGradient(p1.x,p1.y,p2.x,p2.y);
      grad.addColorStop(0,`rgba(255,0,229,${a})`); grad.addColorStop(1,`rgba(0,234,255,${Math.max(0,a-0.1)})`);
      fxctx.strokeStyle=grad; fxctx.lineWidth=lw; fxctx.beginPath(); fxctx.moveTo(p1.x,p1.y); fxctx.lineTo(p2.x,p2.y); fxctx.stroke();
    }
  }
  function drawParticle(p){
    fxctx.save(); fxctx.translate(p.x,p.y); fxctx.rotate(p.rot*Math.PI/180);
    fxctx.fillStyle=p.col;
    if(p.shape==='circle'){ fxctx.beginPath(); fxctx.arc(0,0,p.size/2,0,Math.PI*2); fxctx.fill(); }
    else if(p.shape==='strip'){ fxctx.fillRect(-p.size/2,-p.size/6,p.size,p.size/3); }
    else { fxctx.fillRect(-p.size/2,-p.size/2,p.size,p.size); }
    fxctx.restore();
  }
  function neonBurst(x,y,count=160){
    const N = Math.max(20, Math.round(count * (0.5 + 0.5*perfLevel())));
    for(let i=0;i<N;i++){
      const a=Math.random()*Math.PI*2, s=2+Math.random()*4.4;
      const huePool=[305,185,95]; const hue=huePool[Math.floor(Math.random()*huePool.length)];
      confetti.push({x,y, vx:Math.cos(a)*s, vy:Math.sin(a)*s, ax:0, ay:0.040, rot:0, vr:(Math.random()-.5)*12,
        size:2+Math.random()*3, shape:['circle','strip','rect'][Math.floor(Math.random()*3)],
        col:Math.random()<0.25? 'rgba(255,255,255,.95)' : `hsl(${hue},95%,60%)`, life:0, maxLife:120+Math.random()*80});
    }
    if(!fxAnimId) animateFX();
  }
  function drawRocket(r){
    fxctx.save(); fxctx.translate(r.x,r.y); fxctx.rotate(r.rot||0);
    const s=r.size; fxctx.shadowColor='rgba(255,0,229,.45)'; fxctx.shadowBlur=24;
    fxctx.fillStyle='#e5e7ff'; roundRect(fxctx,-s*0.24,-s*0.55,s*0.48,s*0.98,s*0.24,true); fxctx.shadowBlur=0;
    fxctx.fillStyle='#ff287a'; fxctx.fillRect(-s*0.24,-s*0.04,s*0.48,s*0.10);
    fxctx.beginPath(); fxctx.moveTo(0,-s*0.8); fxctx.lineTo(s*0.24,-s*0.55); fxctx.lineTo(-s*0.24,-s*0.55); fxctx.closePath();
    const nose=fxctx.createLinearGradient(0,-s*0.8,0,-s*0.55); nose.addColorStop(0,'#a1a1ff'); nose.addColorStop(1,'#6967ff'); fxctx.fillStyle=nose; fxctx.fill();
    fxctx.beginPath(); fxctx.arc(0,-s*0.22,s*0.16,0,Math.PI*2);
    const win=fxctx.createRadialGradient(0,-s*0.22,1,0,-s*0.22,s*0.16); win.addColorStop(0,'#dff4ff'); win.addColorStop(1,'#00eaff'); fxctx.fillStyle=win; fxctx.fill();
    fxctx.fillStyle='#ff00e5';
    fxctx.beginPath(); fxctx.moveTo(-s*0.24,s*0.02); fxctx.lineTo(-s*0.50,s*0.30); fxctx.lineTo(-s*0.24,s*0.30); fxctx.closePath(); fxctx.fill();
    fxctx.beginPath(); fxctx.moveTo(s*0.24,s*0.02); fxctx.lineTo(s*0.50,s*0.30); fxctx.lineTo(s*0.24,s*0.30); fxctx.closePath(); fxctx.fill();
    if(!prefersReduced){
      const t=(r.life%6)/6; const L=s*(0.70+Math.sin(t*Math.PI*2)*0.18);
      const g1=fxctx.createLinearGradient(0,s*0.52,0,s*0.52+L);
      g1.addColorStop(0,'#fff2cc');
      g1.addColorStop(0.35,'#ffc04d');
      g1.addColorStop(0.7,'#ff5a00');
      g1.addColorStop(1,'rgba(255,90,0,0)');
      fxctx.fillStyle=g1; fxctx.beginPath(); fxctx.moveTo(-s*0.16,s*0.52); fxctx.lineTo(s*0.16,s*0.52); fxctx.lineTo(0,s*0.52+L); fxctx.closePath(); fxctx.fill();
      const g2=fxctx.createLinearGradient(0,s*0.52,0,s*0.52+L*0.7);
      g2.addColorStop(0,'#ffe8a3');
      g2.addColorStop(1,'rgba(255,160,0,0)');
      fxctx.fillStyle=g2; fxctx.beginPath(); fxctx.moveTo(-s*0.10,s*0.52); fxctx.lineTo(s*0.10,s*0.52); fxctx.lineTo(0,s*0.52+L*0.7); fxctx.closePath(); fxctx.fill();
    }
    fxctx.restore();
  }
  function roundRect(ctx,x,y,w,h,r,fill){ ctx.beginPath(); ctx.moveTo(x+r,y); ctx.arcTo(x+w,y,x+w,y+h,r); ctx.arcTo(x+w,y+h,x,y+h,r); ctx.arcTo(x,y+h,x,y,r); ctx.arcTo(x,y,x+w,y,r); if(fill) ctx.fill(); }
  function screenFlash(a=0.6){ flashAlpha=Math.max(flashAlpha,a); if(!fxAnimId) animateFX(); }
  function launchRocketAt(x, superBurst=false){ if(prefersReduced && !window.forceFX) return;
    const r={ x, y:window.innerHeight+70, vx:(Math.random()-.5)*0.35, vy:-6.5, ax:0, ay:-0.015, size:62, rot:0, life:0, maxLife:260, targetY:window.innerHeight*0.18, super:superBurst, trail:[] };
    rockets.push(r); if(!fxAnimId) animateFX();
  }

  // COMPLETE sync
  let completeHideTimer = null;
  function pulseComplete(){
    const el = $('complete');
    if(!el || !el.classList.contains('show')) return;
    const t = performance.now();
    const s = (Math.sin(t/220)+1)/2;
    const a1 = 0.22 + s*0.50;
    const a2 = 0.12 + s*0.40;
    el.style.setProperty('--glow1', a1.toFixed(3));
    el.style.setProperty('--glow2', a2.toFixed(3));
  }
  function showComplete(ms = 8000){
    const el = $('complete');
    if(!el) return;
    el.classList.add('show');
    if(completeHideTimer) clearTimeout(completeHideTimer);
    completeHideTimer = setTimeout(()=>{
      el.classList.remove('show');
      el.style.removeProperty('--glow1');
      el.style.removeProperty('--glow2');
    }, ms);
  }

  function playFinale(){
    window.forceFX = true;
    const center = window.innerWidth/2;
    const sideOffset = Math.min(240, window.innerWidth*0.25);
    const yTopBase = window.innerHeight*0.18;

    const rocketsPos = [
      {x:center, super:true, side:false},
      {x:center, super:true, side:false},
      {x:center, super:true, side:false},
      {x:center - sideOffset, super:true, side:true},
      {x:center + sideOffset, super:true, side:true},
    ];
    for (let i = rocketsPos.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [rocketsPos[i], rocketsPos[j]] = [rocketsPos[j], rocketsPos[i]];
    }

    let maxDelay = 0;
    const rocketFlightMs = 1600;

    rocketsPos.forEach((r,i)=>{
      const base = r.side ? 2600 : 2000;
      const delay = Math.floor(Math.random()*base) + Math.floor(Math.random()*80)*i;
      if(delay>maxDelay) maxDelay = delay;
      setTimeout(()=>{
        const jitter = 0.9 + Math.random()*0.20;
        const targetY = yTopBase * jitter;
        const rocket = {
          x:r.x, y:window.innerHeight+70,
          vx:(Math.random()-.5)*0.25, vy:-5.6, ax:0, ay:-0.012,
          size:62, rot:0, life:0, maxLife:320,
          targetY, super:r.super, trail:[], exploded:false
        };
        rockets.push(rocket);
        if(!fxAnimId) animateFX();

        if(Math.random() < 0.20){
          setTimeout(()=>{
            const jitter2 = 0.9 + Math.random()*0.20;
            const rocket2 = {
              x: r.x + (Math.random()-.5)*16, y: window.innerHeight+70,
              vx:(Math.random()-.5)*0.25, vy:-5.6, ax:0, ay:-0.012,
              size:62, rot:0, life:0, maxLife:320,
              targetY: yTopBase * jitter2, super:r.super, trail:[], exploded:false
            };
            rockets.push(rocket2);
            if(!fxAnimId) animateFX();
          }, 260 + Math.floor(Math.random()*520));
        }
      }, delay);
    });

    setTimeout(()=>{
      const yTop = yTopBase;
      neonBurst(center,yTop,220);
      neonBurst(center-sideOffset,yTop,180);
      neonBurst(center+sideOffset,yTop,180);
      addShockwave(center,yTop,2);
      addShockwave(center-sideOffset,yTop,1);
      addShockwave(center+sideOffset,yTop,1);
      addDistortion(center,yTop);
      addDistortion(center-sideOffset,yTop);
      addDistortion(center+sideOffset,yTop);
      screenFlash(0.55);

      setTimeout(()=>{
        spawnMeteorRain(1600, 26, pulseComplete);
        showComplete(8000);
      }, 300);

      setTimeout(()=>{ window.forceFX = false; }, 2400);
    }, Math.min(4800, maxDelay + rocketFlightMs + 900 + Math.round((1 - perfLevel())*400)) );
  }

  function applyAchievementUI(pct){
    const cross=(k,thr,pattern)=>{
      if(pct>=thr){
        $('ms'+k).classList.add('achieved');
        if(!milestones[k]){
          milestones[k]=nowStamp(); vibrate(pattern);
          if(k==='100'){
            playFinale();
          } else {
            const cx=window.innerWidth/2, cy=window.innerHeight*0.18;
            launchRocketAt(cx,false);
            setTimeout(()=>{ neonBurst(cx,cy,160); addShockwave(cx,cy,1); addDistortion(cx,cy); },520);
          }
          saveNow(); renderMilestonesMeta();
        }
      } else {
        $('ms'+k).classList.remove('achieved');
      }
    };
    cross('25',.25,[18]);
    cross('50',.50,[20,40,20]);
    cross('75',.75,[25,35,25]);
    cross('100',1.0,[60,40,60,40,90]);
  }
  function recalc(){
    const target=num($('target').value);
    const havePoint=num($('havePoint').value);
    const ppx=Math.max(0,num($('ppx').value));
    const xpx=Math.max(0,num($('xpx').value));
    const haveXu=Math.max(0,num($('haveXu').value));
    const days=Math.max(0,num($('days').value));

    const needPointRaw=Math.max(0,target - havePoint);
    const needTurn=ppx>0 ? Math.ceil(needPointRaw/ppx) : 0;
    const needXu=needTurn*xpx;
    const lackXu=Math.max(0,needXu - haveXu);
    const turnNow=xpx>0 ? Math.floor(haveXu/xpx) : 0;
    const pointNow=turnNow*ppx;
    const perDayTurn=days>0? Math.ceil(needTurn/days) : needTurn;
    const perDayXu=perDayTurn*xpx;
    const perDayPoint=perDayTurn*ppx;

    $('needPoint').textContent=fmtInt(needPointRaw);
    $('needTurn').textContent=fmtInt(needTurn);
    $('needXu').textContent=fmtInt(needXu);
    $('lackXu').textContent=fmtInt(lackXu);
    $('canNow').textContent=`${fmtInt(pointNow)} điểm`;
    $('perDay').textContent=`${fmtInt(perDayXu)} xu • ${fmtInt(perDayTurn)} lượt • ${fmtInt(perDayPoint)} điểm`;

    const pctNow=target>0? havePoint/target : 0;
    const pctMax=target>0? Math.min(1,(havePoint+pointNow)/target) : 0;
    const pct= ringMode==='max' ? pctMax : pctNow;
    const circ=2*Math.PI*50;
    $('ring').setAttribute('stroke-dasharray', String(circ));
    $('ring').setAttribute('stroke-dashoffset', String(circ * (1 - pct)));
    $('pct').textContent=Math.round(pct*100)+'%';
    $('bar').style.width=Math.round(pct*100)+'%';
    if(pct>=1 && !finalePlayed){ playFinale(); finalePlayed=true; }
    applyAchievementUI(pct); saveNow();
  }

  function bindEvents(){
    $('finaleBtn').addEventListener('click', ()=>{ playFinale(); });
    $('modeNow').addEventListener('click', ()=>{ ringMode='now'; setModeButtons(); recalc(); saveNow(); });
    $('modeMax').addEventListener('click', ()=>{ ringMode='max'; setModeButtons(); recalc(); saveNow(); });
    $('confettiBtn').addEventListener('click', ()=> { const cx=window.innerWidth/2, cy=window.innerHeight*0.3; neonBurst(cx,cy,160); addShockwave(cx,cy,1); addDistortion(cx,cy); });
    $('copyBtn').onclick = async () => {
      const lines = [
        `Mốc: ${$('target').value}`, `Ngày còn lại: ${$('days').value}`,
        `Điểm hiện có: ${$('havePoint').value}`, `Tốc độ đổi: ${$('ppx').value} điểm / ${$('xpx').value} xu`,
        `Xu hiện có: ${$('haveXu').value}`, `— Kết quả —`,
        `Còn thiếu: ${$('needPoint').textContent} điểm`, `Cần đổi: ${$('needTurn').textContent} lượt`,
        `Xu cần: ${$('needXu').textContent} (thiếu: ${$('lackXu').textContent})`,
        `Kế hoạch/ngày: ${$('perDay').textContent}`,
        `— Checklist —`,
        `25%: ${$('ts25')? $('ts25').textContent : ''}`,
        `50%: ${$('ts50')? $('ts50').textContent : ''}`,
        `75%: ${$('ts75')? $('ts75').textContent : ''}`,
        `100%: ${$('ts100')? $('ts100').textContent : ''}`
      ];
      try{ await navigator.clipboard.writeText(lines.join('\n')); toast('Đã copy kế hoạch vào clipboard'); }
      catch(e){ toast('Copy không thành công'); }
    };
    $('resetBtn').onclick = () => {
      ['target','days','havePoint','haveXu','ppx','xpx'].forEach(id => $(id).value = '');
      milestones = { "25": null, "50": null, "75": null, "100": null };
      renderMilestonesMeta();
      recalc(); toast('Đã xoá dữ liệu đã lưu');
    };
    $('resetMs').onclick = () => {
      milestones = { "25": null, "50": null, "75": null, "100": null };
      renderMilestonesMeta();
      saveNow();
      toast('Đã reset checklist');
    };
    const inputs = Array.from(document.querySelectorAll('input'));
    inputs.forEach(el=>['input','change','keyup','paste','blur'].forEach(ev=> el.addEventListener(ev, recalc)));
  }

  document.addEventListener('DOMContentLoaded', ()=>{ loadSaved(); setModeButtons(); bindEvents(); recalc(); });
  </script>
</body>
</html>
